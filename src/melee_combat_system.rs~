use specs::prelude::*;
use super::{Stats, MeleeIntent, DamageQueue, BasicAttack, particle_system::ParticleBuilder, Position};

pub struct MeleeCombatSystem {}

impl<'a> System<'a> for MeleeCombatSystem {
    type SystemData = ( Entities<'a>,
                        WriteExpect<'a, ParticleBuilder>,
                        WriteStorage<'a, MeleeIntent>, 
                        WriteStorage<'a, DamageQueue>,
                        ReadStorage<'a, BasicAttack>,
                        ReadStorage<'a, Stats>,
                        ReadStorage<'a, Position>,
                      );
    fn run(&mut self, data: Self::SystemData) {
        let (entities, mut particle_builder, mut melee_intents, mut damage_queues,
             basic_attacks, stats, positions) = data;

        //Queue dmg from all living entities with MeleeIntent.
        for (entity, melee_intent, basic_attack) in
            (&entities, &melee_intents, &basic_attacks).join() { 
            
            //If entity with intent is dead, well... they can't melee.
            if stats.get(entity).unwrap().hp <= 0 {return;}

            let target = melee_intent.target;
            let t_stats = stats.get(target).unwrap();

            if t_stats.hp > 0 {   
                DamageQueue::queue_damage(&mut damage_queues, target, basic_attack.current);
            }

            //spawn particle
            let pos = positions.get(melee_intent.target);
            if let Some(pos) = pos {
                particle_builder.request(pos.x, pos.y, rltk::RGB::named(rltk::ORANGE),
                    rltk::RGB::named(rltk::BLACK), rltk::to_cp437('â€¼'), 200.0);
            }
        }
        
        melee_intents.clear();
    }
}
